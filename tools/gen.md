# 妙码代码生成工具 (gen.sh) 功能文档

## 概述

`gen.sh` 是妙码项目的核心代码生成脚本，支持配置文件驱动的代码生成功能。该脚本提供了统一的接口来执行不同模式的代码生成任务。

## 功能特性

### 1. 命令行参数解析
- `-o, --output DIR`: 指定输出目录（必需参数）
- `-h, --help`: 显示帮助信息
- 支持参数验证和错误处理

### 2. 工作目录管理
- 自动检测并切换到miaoma项目根目录
- 通过查找 `miaoma.py`、`src`、`assets` 目录来确定根目录
- 支持从任意子目录执行脚本

### 3. 配置文件读取
- 读取 `tools/project.ini` 配置文件
- 支持的配置项：
  - `MIAOMA_CONFIG_PROJECT_PATH`: 项目路径
  - `MIAOMA_DATABASE_FILE`: 数据库文件路径
  - `MIAOMA_DATABASE_PATH`: 数据库目录路径
  - `TOOL_MODE`: 工具模式（1=单文件模式，2=工程模式）
  - `SHOW_PYTHON_LOGS`: 是否显示Python日志
- 配置验证和错误处理

### 4. 双模式支持
- **模式1（单文件模式）**: 使用 `gen-code` 命令处理单个SQL文件
- **模式2（工程模式）**: 使用 `gen-project` 命令处理整个数据库目录

### 5. 输出目录管理
- 支持相对路径和绝对路径
- 自动创建不存在的输出目录
- 清理旧的生成文件（artifacts和config目录）

### 6. 命令执行和日志处理
- 根据 `SHOW_PYTHON_LOGS` 配置控制日志显示
- 捕获Python命令输出到临时日志文件
- 提取并保存实际输出目录到 `.last_output_dir` 文件
- 支持静默执行模式

### 7. 日志系统
- 集成统一的日志工具（logger.sh）
- 支持多级别日志：DEBUG、INFO、WARN、ERROR、SUCCESS
- 彩色输出支持
- 可选时间戳显示

## 执行流程

1. **初始化**: 解析命令行参数
2. **环境设置**: 确定并切换到miaoma根目录
3. **配置读取**: 加载project.ini配置文件
4. **目录检查**: 验证和准备输出目录
5. **命令执行**: 根据模式执行相应的Python命令
6. **结果处理**: 提取输出目录并保存
7. **清理**: 删除临时文件

## 依赖关系

- `logger.sh`: 提供日志功能
- `miaoma.py`: 核心Python脚本
- `project.ini`: 配置文件
- Python 3环境

## 错误处理

- 参数验证失败时显示帮助信息并退出
- 配置文件缺失或格式错误时报错退出
- 依赖文件不存在时报错退出
- Python命令执行失败时提供调试提示

## 使用示例

```bash
# 基本使用
./gen.sh -o /path/to/output

# 使用相对路径
./gen.sh --output ./output

# 显示帮助
./gen.sh --help
```